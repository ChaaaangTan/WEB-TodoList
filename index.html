<script src="src/todo.js" charset="utf-8"></script>
<script src="src/login_util.js" charset="utf-8"></script>
<script src="https://imgcache.qq.com/qcloud/tcbjs/1.10.8/tcb.js"></script>
<script>
    let uid = null;
    const app = tcb.init({
        env:"更换自己的云环境ID"
    })
    const auth = app.auth({
        persistence: "local"
    });
    const db = app.database();
    window.onload = function () {
        LO.init();
        TODO.init();
    }
    LO.Done = function(){
        uid = app.auth().hasLoginState().user.uid;
        db.collection('todo').doc(uid).get().then(res=>{
            if(res.data.length==0){
                db.collection('todo').add({
                    _id:uid,
                    list:TODO.todo,
                    time:new Date()
                }).then(res=>{
                    console.log(res);
                    watchtodo();
                })
            }
            else{
                console.log(res);
                TODO.todo = res.data[0].list;
                TODO.todoinit();
                watchtodo();
            }
        });
    }
    TODO.itemChange = function(id,type,des){
        db.collection('todo').doc(uid).update({
            list:db.command.set(TODO.todo),
            time:new Date()
        }).then(res=>{
        }).catch(e=>{
            console.log(e);
        })
    };
    function watchtodo(){
        db.collection('todo').where({ _id:uid }).watch({
            onChange: (snapshot) => {
                if(snapshot.msgType!="INIT_EVENT"){
                    TODO.todo = snapshot.docs[0].list;
                    TODO.todoinit();
                }
            },
            onError: (error) => {
                alert('远端数据库监听失败！');
            }
        });
    }
</script>